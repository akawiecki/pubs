---
title: "DAG jokes"
author: "Ania Kawiecki"
date: "9/29/2020"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(message=FALSE)
```

```{r libraries, message= FALSE}

library(tidyverse)
library(rethinking)
library(dagitty)
library(knitr)
library("ggdag")


```

**Resources** 

* DAG and bias theory

[Causal Knowledge as a Prerequisite for Confounding Evaluation: An Application to Birth Defects Epidemiology, Hernàn 2002](https://academic.oup.com/aje/article/155/2/176/108106)

[Statistical Rethinking: A Bayesian Course with Examples in R and Stan. Second edition by Richard McElreath](http://xcelab.net/rm/statistical-rethinking/)


* ggdag

https://ggdag.malco.io/

https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html

https://malco.io/2019/09/17/tidy-causal-dags-with-ggdag-0-2-0/

https://cran.r-project.org/web/packages/ggdag/vignettes/bias-structures.html

https://malco.io/2019/09/17/tidy-causal-dags-with-ggdag-0-2-0/



# **Causal inference** 

Causal inference is the process of drawing a conclusion about a causal connection based on the conditions of the occurrence of an effect. The main difference between causal inference and inference of association is that the former analyzes the response of the effect variable when the cause is changed. (https://en.wikipedia.org/wiki/Causal_inference#:~:text=Causal%20inference%20is%20the%20process,when%20the%20cause%20is%20changed.)

(Hernán 2002)

A statistical association between an exposure (E) and an outcome (O) can be due to either or both: 

## a **causal effect** : E causes O (ex: smoking and lung cancer). This is the effect we want to isolate using causal inference.

```{r dag1, echo =FALSE}

coords <- list(
  x = c(E = 1, O = 2),
  y = c(E = 0, O = 0)
) %>% 
   coords2df()

dag1.1 <- dagify( 
  O ~ E, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag1.1) +
  theme_dag()
```


* a **spurious effect** =  **confounder** : E and O have a common cause. This is the effect we want to eliminate in order to isolate the causal effect. 

```{r dag2, echo =FALSE}
coords <- list(
  x = c(E = 1, O = 3, C=2),
  y = c(E = 0, O = 0, C=1)
) %>% 
   coords2df()


dag2 <- dagify( 
  E ~ C,
  O ~ C, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag2, layout= "grid") +
  theme_dag()

```


A third effect between 2 variables can be 

* a **common effect** = **collider**

```{r dag3, echo =FALSE}
coords <- list(
  x = c(E = 1, O = 3, C=2),
  y = c(E = 0, O = 0, C=1)
) %>% 
   coords2df()


dag3 <- dagify( 
  C ~ E,
  C ~ O, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag3, layout= "grid") +
  theme_dag()

```


## causal effect 

The total causal effect is the sum of the direct and indirect effects 

```{r dag1.3, echo =FALSE}

coords <- list(
  x = c(E = 1, J=2, O = 3),
  y = c(E = 0, O = 0, J = 1)
) %>% 
   coords2df()

dag1.3 <- dagify( 
  J ~ E,
  O ~ J, 
  O ~ E, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag1.3) +
  theme_dag()
```

* direct effect
  
```{r dag1.1, echo =FALSE}

coords <- list(
  x = c(E = 1, O = 2),
  y = c(E = 0, O = 0)
) %>% 
   coords2df()

dag1.1 <- dagify( 
  O ~ E, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag1.1) +
  theme_dag()
```

* indirect effect
  
```{r dag1.2, echo =FALSE}
coords <- list(
  x = c(E = 1, J=2, O = 3),
  y = c(E = 0, O = 0, J = 1)
) %>% 
   coords2df()

dag1.2 <- dagify( 
  J ~ E,
  O ~ J, 
  exposure = "E",
  outcome = "O",
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

ggdag(dag1.2) +
  theme_dag()
```


### Obtaining an unbiased estimate of the causal effect: 

* Obtaining an unbiased estimate of the total effect requires measuring and adjusting for all confounders of the E $\to$ O association 

* Obtaining an unbiased estimate of the direct effect requires measuring and adjusting for all confounders of both the 
  + J $\to$ O association 
  + E $\to$ O association 

Examples: 

1. 
```{r dag1.4, echo =FALSE}

coords <- list(
  x = c(E = 1, J=2, C= 3, O = 3),
  y = c(E = 0, O = 0, J = 1, C= 2)
) %>% 
   coords2df()

dag1.4 <- dagify( 
  J ~ E,
  O ~ J, 
  O ~ E,
  O ~ C,
  J ~ C, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

dag1.4 %>% 
  ggdag_dseparated(from = "E", to = "O")+
    theme_dag()
```

* To obtain the total causal effect we condition on C but not J:

  + C is a confounder of the J $\to$ O association so we must condition on it to obtain the unbiased total causal effect 

```{r adjust C}
dag1.4 %>% 
ggdag_dseparated(from = "E", to = "O", controlling_for = "C")+
  theme_dag()
```
  
  + J is a collider of the E $\to$ C association so if we condition on J we create a backdoor path between O $\to$ E through C. 
  
```{r adjust J}
dag1.4 %>% 
ggdag_dseparated(from = "E", to = "O", controlling_for = "J")+
  theme_dag()
```
  

* To obtain the direct causal effect we condition on both J and C. 

```{r adjust JC}
dag1.4 %>% 
ggdag_dseparated(from = "E", to = "O", controlling_for = c("J", "C"))+
  theme_dag()
```

2. 
```{r dag1.5, echo =FALSE}

coords <- list(
  x = c(E = 1, J=2, C= 3, O = 3, D = 2),
  y = c(E = 0, O = 0, J = 1, C= 2, D = -1)
) %>% 
   coords2df()

dag1.5 <- dagify( 
  J ~ E,
  O ~ J, 
  O ~ E,
  O ~ C,
  J ~ C,
  O ~ D, 
  E~ D, 
  exposure = "E",
  outcome = "O", 
  coords = coords2list(coords)) %>% 
  tidy_dagitty()

dag1.5 %>% 
  ggdag_dseparated(from = "E", to = "O")+
    theme_dag()
```
* To obtain the total causal effect we condition on D

```{r adjust D}
dag1.5 %>% 
ggdag_dseparated(from = "E", to = "O", controlling_for = "D")+
  theme_dag()
```

* To obtain the total causal effect we condition on C, D, J

```{r adjust JCD, warning=FALSE}

dag1.5 %>% 
ggdag_dseparated(from = "E", to = "O", controlling_for = c("C", "D", "J"))+
  theme_dag()
```

## spurious effect

The exposed and the unexposed in the study are not comparable, or exchangeable, which is the ultimate source of the bias ( the unexposed group is not the counterfactual of the exposed group)

* There is **confounding** when the association between exposure and outcome includes a noncausal component attributable to their having an uncontrolled common cause. 

* There is **selection bias** when the association between exposure and outcome includes a noncausal component attributable to restricting the analysis to certain level(s) of a common effect of exposure and outcome or, more generally, to conditioning on a common effect of variables correlated with exposure and outcome. 

### strategies to identify confounders

1. automatic variable selection procedures: i.e stepwise regression. It assumes that all important confounders will be selected 

2. change in effect estimate: comparison of the effect estimates between adjusted and unadjusted effect estimates. The variable is selected as a confounder if there is a relative change greater than 10%. It assumes that any variable substantially associated with an estimate change is worth adjusting for.

3. check whether the variable meets the criteria of a confounder: combines information from statistical associations and background knowledge. 

**Confounder** 

a variable that is: 

* associated with the outcome, conditional on the exposure (i.e. in the exposed group)
* associated with the exposure, conditional on the exposure (i.e. in the exposed group)
* not on the causal pathway between the exposure and the outcome.


Strategies 1 and 2 rest only on statistical associations that can easily be identified from the data. Strategy 3 combines statistical associations from the data with some background knowledge about the causal network that links exposure, outcome, and potential confounders. 

Statistical criteria alone are insufficient to characterize either confounding or selection bias.

The presence of common causes, and therefore of confounding, can be represented by causal diagrams known as directed acyclic graphs (DAGs). 

**DAG = directed acyclic graph**: these diagrams link variables by arrows that represent direct causal effects (protective or causative) of one variable on another.



### strategies to control confounders

* study design: 
    + randomization
    + restriction 
    
    
* study design + study analysis: 
    + matching
    
    
* study analysis 
    + stratification: 
    + standarization 
    + inverse probability treatment
    + multivariate adjustment 

##



